{% extends "Fleet/base.html" %}
{% load static %}
{% block title %}Rejestr przejazdów{% endblock %}

{% block content %}
<div class="mt-4">
  <h2 class="mb-3">Rejestr przejazdów</h2>

  <label for="sortSelect">Sortuj po:</label>
  <select id="sortSelect" class="form-select form-select-sm" style="width: auto;">
    <option value="title">Nazwa</option>
    <option value="create_at">Data</option>
    <option value="distance">Dystans</option>
  </select>

  <table id="ridesTable" class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Lp.</th>
        <th>Nazwa</th>
        <th>Treść</th>
        <th>Data</th>
        <th>Autor</th>
        <th>Akcja</th>
      </tr>
    </thead>
    <tbody>
      {% for post in posts %}
      <tr id="post-{{ post.id }}">
        <td>{{ forloop.counter }}</td>
        <td>{{ post.title }}</td>
        <td>{{ post.content }}</td>
        <td>{{ post.create_at|date:"d.m.Y H:i" }}</td>
        <td>{{ post.author.profile.display_name }}</td>
        <td>
          <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#detailModal"
                  data-id="{{ post.id }}">
            Szczegóły
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center">Brak przejazdów.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% include "Fleet/partials/_detail_modal.html" %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Pobieramy wszystkie przyciski Szczegóły w tabeli
    const detailsButtons = document.querySelectorAll("button[data-id]");

    detailsButtons.forEach(button => {
        button.addEventListener("click", function () {
            // Pobieramy ID posta z atrybutu data-id
            const postId = this.getAttribute("data-id");

            // Wysyłamy zapytanie do widoku post_detail_json, aby pobrać szczegóły posta
            fetch(`/posts/detail/${postId}/`)
                .then(response => response.json()) // Odbieramy odpowiedź w formacie JSON
                .then(data => {
                    // Podstawowe informacje, dostępne dla wszystkich użytkowników
                    document.querySelector("#detailModal .modal-title").innerText = data.title;
                    document.querySelector("#detailModal #modalContent").innerText = data.content;
                    document.querySelector("#detailModal #modalDate").innerText = data.create_at;
                    document.querySelector("#detailModal #modalAuthor").innerText = data.author;

                    // Jeśli użytkownik jest właścicielem posta, dodajemy więcej informacji
                    if (data.edit_url) {
                        document.querySelector("#detailModal #modalDistance").innerText = data.distance ? data.distance + " km" : "Brak danych";
                        document.querySelector("#detailModal #modalStart").innerText = data.start_location || "Brak informacji";
                        document.querySelector("#detailModal #modalEnd").innerText = data.end_location || "Brak informacji";
                        document.querySelector("#detailModal #modalTime").innerText = data.travel_time || "Brak danych";
                        document.querySelector("#detailModal #modalVehicle").innerText = data.vehicle || "Brak informacji";

                        // Pokazujemy dodatkowe pola tylko dla właściciela
                        document.querySelector("#detailModal #ownerDetails").style.display = "block";
                    } else {
                        // Ukrywamy dodatkowe pola dla innych użytkowników
                        document.querySelector("#detailModal #ownerDetails").style.display = "none";
                    }
                })
                .catch(error => console.error("Błąd pobierania danych:", error));
        });
    });
});
</script>

{% endblock %}


